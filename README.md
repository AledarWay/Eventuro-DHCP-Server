# Eventuro DHCP Server

Это реализация DHCP-сервера на Python с веб-интерфейсом управления, базой данных для хранения аренд (leases), историей изменений, уведомлениями в Telegram и API для внешнего доступа. Сервер предназначен для управления распределением IP-адресов в локальной сети, с поддержкой динамических и статических привязок.

## Основные возможности

- **Обработка DHCP-запросов**: Поддержка DISCOVER, OFFER, REQUEST, ACK, NAK, DECLINE, RELEASE и INFORM. Автоматическая выдача IP из пула или статических привязок.
- **База данных аренд**: Хранение информации о клиентах (MAC, IP, hostname, тип аренды, время истечения) в SQLite. Автоматическая пометка истекших аренд.
- **История изменений**: Логирование всех действий (выдача аренды, обновление, блокировка и т.д.) в отдельной БД с возможностью просмотра в веб-интерфейсе.
- **Веб-интерфейс**: Flask-приложение для просмотра/управления клиентами:
  - Список клиентов с фильтрами (по типу аренды, статусу).
  - Добавление/удаление статических привязок (единичное и массовое).
  - Блокировка/разблокировка устройств.
  - Установка/сброс имени хоста или аренды.
  - Пометка устройства как доверенного (используется только для передачи в API, для внешних интеграций).
  - Просмотр истории изменений для каждого клиента и общей истории.
  - Статистика (занятые/свободные адреса, статические/динамические привязки).
  - Аутентификация (логин/пароль, с настройкой при первом запуске).
  - Тёмная тема и пагинация.
- **Telegram-уведомления**: Отправка сообщений о новых устройствах или устройствах, подключившихся после долгого отсутствия.
- **API**: Защищённый токеном доступ к информации о клиентах (/api/client/<ip> и /api/clients).
- **Кэширование**: Кэш для повторных DHCP-запросов и API-ответов для снижения нагрузки.
- **Логирование**: Подробные логи в файл с ротацией, уровень логирования настраивается.
- **Автоматическая миграция подсети**: При изменении конфига подсети сервер мигрирует существующие аренды.
- **Очистка истории**: Автоматическая очистка старых записей (LEASE_RENEWED и INFORM) старше заданного периода.

## Требования

- Python (тестировалось на версиях 3.10-3.12)
- Библиотеки: flask, werkzeug, netifaces, sqlite3 (встроенная), requests, logging (встроенная).
- Нет внешних зависимостей для установки пакетов (все встроено или стандартные библиотеки).
- ОС: Linux/Windows (рекомендуется Linux, но работа также проверена на Windows).

## Установка

1. Клонируйте репозиторий:
   ```
   git clone <repository_url>
   cd eventuro-dhcp-server
   ```

2. Убедитесь, что Python установлен. Нет необходимости в `pip install`, так как все зависимости стандартные.

3. Настройте конфигурацию в `config.json` (см. ниже).

4. Запустите сервер для проверки:
   ```
   python main.py
   ```

5. Создайте службу для запуска сервера. Пример службы для openwrt в разделе `openwrt-service`.

При первом запуске веб-интерфейс (стандартный порт 5500) предложит создать учётную запись (логин/пароль).

## Конфигурация

Конфигурация хранится в файле `config.json` в корне проекта. Все пути к файлам (БД, логи) указываются относительно корня проекта. Пример файла:

```json
{
    "interface": "br-lan",
    "server_ip": "192.168.1.1",
    "pool_start": "192.168.1.50",
    "pool_end": "192.168.1.240",
    "subnet_mask": "255.255.255.0",
    "gateway": "192.168.1.1",
    "dns_servers": ["8.8.8.8", "1.1.1.1"],
    "lease_time": 604800,
    "domain_name": "MyDomain.local",
    "cache_ttl": 30,
    "api_cache_ttl": 30,
    "web_host": "0.0.0.0",
    "web_port": 5500,
    "db_file": "dhcp_leases.db",
    "auth_db_file": "web_auth.db",
    "history_db_file": "dhcp_lease_history.db",
    "history_cleanup_days": 30,
    "log_file": "dhcp_server.log",
    "log_level": "INFO",
    "api_token": "6pItIzsU9UYVYRW0OEEjTxg0A6k2JBjBSGgtCEOjqFypkP9g6iDadILVbzS4jLAj",
    "expire_check_period": 300,
    "web_lease_history_limit": 10,
    "telegram_enabled": false,
    "telegram_notify_new_device": true,
    "telegram_notify_inactive_device": true,
    "inactive_period": "7d",
    "telegram_bot_token": "BOT_TOKEN_HERE",
    "telegram_chat_id": "CHAT_ID_HERE",
    "telegram_thread_id": "THREAD_ID_HERE",
    "telegram_web_url": "http://192.168.1.1:5500/",
    "telegram_retries": 3,
    "telegram_retry_interval": 5,
    "max_log_size_mb": 10,
    "max_log_backup_count": 10
}
```

### Описание параметров

- **interface**: Сетевой интерфейс для прослушки (например, "br-lan"). Если не указан, используется broadcast.
- **server_ip**: IP-адрес DHCP-сервера.
- **pool_start** / **pool_end**: Диапазон динамического пула IP.
- **subnet_mask**: Маска подсети.
- **gateway**: Шлюз по умолчанию.
- **dns_servers**: Список DNS-серверов (массив строк).
- **lease_time**: Время аренды в секундах (по умолчанию 604800 = 7 дней).
- **domain_name**: Доменное имя сети.
- **cache_ttl**: TTL кэша для повторных DHCP-запросов (секунды).
- **api_cache_ttl**: TTL кэша для API-ответов (секунды).
- **web_host** / **web_port**: Хост и порт для веб-сервера (по умолчанию 0.0.0.0:5500).
- **db_file**: Путь к БД аренд (SQLite).
- **auth_db_file**: Путь к БД аутентификации (SQLite).
- **history_db_file**: Путь к БД истории (SQLite).
- **history_cleanup_days**: Дней для хранения истории (0 = отключено; очищает только LEASE_RENEWED и INFORM).
- **log_file**: Путь к файлу логов.
- **log_level**: Уровень логирования ("DEBUG", "INFO", "WARNING", "ERROR").
- **api_token**: Токен для доступа к API (генерируйте случайный).
- **expire_check_period**: Интервал проверки истекших аренд (секунды).
- **web_lease_history_limit**: Лимит отображения записей истории на клиента в веб-интерфейсе.
- **telegram_enabled**: Включить уведомления в Telegram (true/false).
- **telegram_notify_new_device**: Уведомлять о новых устройствах.
- **telegram_notify_inactive_device**: Уведомлять о устройствах после долгого отсутствия.
- **inactive_period**: Период неактивности для уведомлений (формат: "7d" для дней, "1h" для часов, "30m" для минут, "1y" для года).
- **telegram_bot_token**: Токен Telegram-бота.
- **telegram_chat_id**: ID чата для уведомлений.
- **telegram_thread_id**: ID темы в чате (опционально).
- **telegram_web_url**: URL веб-интерфейса для ссылок в уведомлениях.
- **telegram_retries**: Количество попыток отправки уведомления.
- **telegram_retry_interval**: Интервал между попытками (секунды).
- **max_log_size_mb**: Максимальный размер лог-файла (МБ) перед ротацией.
- **max_log_backup_count**: Количество резервных лог-файлов.

Конфиг валидируется при запуске. Если подсеть изменилась, сервер автоматически мигрирует аренды.

## Запуск и использование

- Запустите `python main.py`. Сервер стартует DHCP и веб-сервер.
- Доступ к веб-интерфейсу: `http://<server_ip>:5500/`.
- API: 
  - `/api/client/<ip>?token=<api_token>`: Информация о клиенте по IP.
  - `/api/clients?token=<api_token>`: Список всех клиентов.
